Description: sudoedit: do not permit editor arguments to include "--"
Origin: upstream
Bug-Debian-Security: https://security-tracker.debian.org/tracker/CVE-2023-22809

We use "--" to separate the editor and arguments from the files to edit.
If the editor arguments include "--", sudo can be tricked into allowing
the user to edit a file not permitted by the security policy.
Thanks to Matthieu Barjole and Victor Cutillas of Synacktiv
(https://synacktiv.com) for finding this bug.

Index: sudo-1.8.10p3/plugins/sudoers/sudoers.c
===================================================================
--- sudo-1.8.10p3.orig/plugins/sudoers/sudoers.c	2023-01-18 10:21:25.923293548 +0100
+++ sudo-1.8.10p3/plugins/sudoers/sudoers.c	2023-01-18 13:25:04.648832804 +0100
@@ -983,8 +983,8 @@
 static char *
 resolve_editor(const char *ed, size_t edlen, int nfiles, char **files, char ***argv_out)
 {
-    char *cp, **nargv, *editor, *editor_path = NULL;
-    int ac, i, nargc;
+    char *cp, **nargv = NULL, *editor, *editor_path = NULL;
+    int ac, i, nargc = 0;
     bool wasblank;
     debug_decl(resolve_editor, SUDO_DEBUG_PLUGIN)
 
@@ -1017,6 +1017,22 @@
     nargv = (char **) emalloc2(nargc + 1 + nfiles + 1, sizeof(char *));
     for (ac = 0; cp != NULL && ac < nargc; ac++) {
 	nargv[ac] = cp;
+
+        /*
+         * We use "--" to separate the editor and arguments from the files
+         * to edit.  The editor arguments themselves may not contain "--".
+         */
+        /*
+         * as there is no way to examine the result of this check later
+         * (errno is not yet considered for the resolve_editor() call)
+         * we already exit here in case of strange parameters
+         */
+        if (strcmp(nargv[ac], "--") == 0) {
+            warningx(U_("ignoring editor: %.*s"), (int)edlen, ed);
+            warningx("%s", U_("editor arguments may not contain \"--\""));
+            exit(EXIT_FAILURE);
+        }
+
 	cp = strtok(NULL, " \t");
     }
     nargv[ac++] = "--";
