
# HG changeset patch
# User Todd C. Miller <Todd.Miller@courtesan.com>
# Date 1360338152 18000
# Node ID 0c0283d1fafafc0d5cf93a764f4c72a0610e6301
# Parent  36f1598f6c3c1dfb00f23a0a12a21551ba6f07c3
Store the session ID in the tty ticket file too.  A tty may only
be in one session at a time so if the session ID doesn't match we
ignore the ticket.

Index: sudo-1.7.4p4/check.c
===================================================================
--- sudo-1.7.4p4.orig/check.c	2013-03-06 18:46:20.000000000 +0000
+++ sudo-1.7.4p4/check.c	2013-03-06 18:49:28.292003985 +0000
@@ -82,6 +82,7 @@
     dev_t rdev;			/* tty device ID */
     ino_t ino;			/* tty inode number */
     struct timeval ctime;	/* tty inode change time */
+    pid_t sid;			/* ID of session with controlling tty */
 } tty_info;
 
 static void  build_timestamp	__P((char **, char **));
@@ -106,13 +107,14 @@
     struct stat sb;
     int status;
 
-    /* Stash the tty's ctime for tty ticket comparison. */
+    /* Stash the tty's device, session ID and ctime for ticket comparison. */
     if (def_tty_tickets && user_ttypath && stat(user_ttypath, &sb) == 0) {
 	tty_info.dev = sb.st_dev;
 	tty_info.ino = sb.st_ino;
 	tty_info.rdev = sb.st_rdev;
 	if (tty_is_devpts(user_ttypath))
 	    ctim_get(&sb, &tty_info.ctime);
+	tty_info.sid = user_sid;
     }
 
     /* Always prompt for a password when -k was specified with the command. */
Index: sudo-1.7.4p4/config.h.in
===================================================================
--- sudo-1.7.4p4.orig/config.h.in	2010-08-06 14:17:26.000000000 +0000
+++ sudo-1.7.4p4/config.h.in	2013-03-06 18:49:28.292003985 +0000
@@ -170,6 +170,9 @@
    passwords) */
 #undef HAVE_GETPWANAM
 
+/* Define to 1 if you have the `getsid' function. */
+#undef HAVE_GETSID
+
 /* Define to 1 if you have the `getspnam' function (SVR4-style shadow
    passwords) */
 #undef HAVE_GETSPNAM
Index: sudo-1.7.4p4/configure
===================================================================
--- sudo-1.7.4p4.orig/configure	2010-09-06 12:03:39.000000000 +0000
+++ sudo-1.7.4p4/configure	2013-03-06 18:50:50.416004674 +0000
@@ -14812,7 +14812,7 @@
 
 for ac_func in strchr strrchr memchr memcpy memset sysconf tzset \
 	       strftime setrlimit initgroups getgroups fstat gettimeofday \
-	       regcomp setlocale getaddrinfo setenv vhangup \
+	       regcomp setlocale getaddrinfo getsid setenv vhangup \
 	       mbr_check_membership setrlimit64
 do :
   as_ac_var=`$as_echo "ac_cv_func_$ac_func" | $as_tr_sh`
Index: sudo-1.7.4p4/configure.in
===================================================================
--- sudo-1.7.4p4.orig/configure.in	2010-09-06 12:03:33.000000000 +0000
+++ sudo-1.7.4p4/configure.in	2013-03-06 18:49:46.084004135 +0000
@@ -1912,7 +1912,7 @@
 AC_FUNC_GETGROUPS
 AC_CHECK_FUNCS(strchr strrchr memchr memcpy memset sysconf tzset \
 	       strftime setrlimit initgroups getgroups fstat gettimeofday \
-	       regcomp setlocale getaddrinfo setenv vhangup \
+	       regcomp setlocale getaddrinfo getsid setenv vhangup \
 	       mbr_check_membership setrlimit64)
 AC_CHECK_FUNCS(getline, [], [
     AC_LIBOBJ(getline)
Index: sudo-1.7.4p4/sudo.c
===================================================================
--- sudo-1.7.4p4.orig/sudo.c	2010-09-06 12:16:09.000000000 +0000
+++ sudo-1.7.4p4/sudo.c	2013-03-06 18:49:28.316003985 +0000
@@ -671,6 +671,9 @@
 #ifdef HAVE_MBR_CHECK_MEMBERSHIP
     mbr_uid_to_uuid(user_uid, user_uuid);
 #endif
+#ifdef HAVE_GETSID
+    user_sid = getsid(0);
+#endif
     if (user_shell == NULL || *user_shell == '\0')
 	user_shell = estrdup(sudo_user.pw->pw_shell);
 
Index: sudo-1.7.4p4/sudo.h
===================================================================
--- sudo-1.7.4p4.orig/sudo.h	2010-08-06 13:44:30.000000000 +0000
+++ sudo-1.7.4p4/sudo.h	2013-03-06 18:49:28.316003985 +0000
@@ -60,6 +60,7 @@
     char *krb5_ccname;
     char *display;
     char *askpass;
+    pid_t sid;
     int   ngroups;
     GETGROUPS_T *groups;
     struct list_member *env_vars;
@@ -162,6 +163,7 @@
 #define user_shell		(sudo_user.shell)
 #define user_ngroups		(sudo_user.ngroups)
 #define user_groups		(sudo_user.groups)
+#define user_sid		(sudo_user.sid)
 #define user_tty		(sudo_user.tty)
 #define user_ttypath		(sudo_user.ttypath)
 #define user_cwd		(sudo_user.cwd)
