
# HG changeset patch
# User Todd C. Miller <Todd.Miller@courtesan.com>
# Date 1361821758 18000
# Node ID 049a12a5cc14ccc9ae5d02282e5b30b8f5ba2854
# Parent  3334bc8721112830eddadc334a5417ff6b428cce
Store the session ID in the tty ticket file too.  A tty may only
be in one session at a time so if the session ID doesn't match we
ignore the ticket.

Index: sudo-1.8.5p2/plugins/sudoers/check.c
===================================================================
--- sudo-1.8.5p2.orig/plugins/sudoers/check.c	2013-02-28 22:48:59.037834126 -0500
+++ sudo-1.8.5p2/plugins/sudoers/check.c	2013-02-28 22:48:59.033834126 -0500
@@ -82,6 +82,7 @@
     dev_t rdev;			/* tty device ID */
     ino_t ino;			/* tty inode number */
     struct timeval ctime;	/* tty inode change time */
+    pid_t sid;			/* ID of session with controlling tty */
 } tty_info;
 
 static int   build_timestamp(char **, char **);
@@ -135,13 +136,14 @@
     if (!need_pass)
 	goto done;
 
-    /* Stash the tty's ctime for tty ticket comparison. */
+    /* Stash the tty's device, session ID and ctime for ticket comparison. */
     if (def_tty_tickets && user_ttypath && stat(user_ttypath, &sb) == 0) {
 	tty_info.dev = sb.st_dev;
 	tty_info.ino = sb.st_ino;
 	tty_info.rdev = sb.st_rdev;
 	if (tty_is_devpts(user_ttypath))
 	    ctim_get(&sb, &tty_info.ctime);
+	tty_info.sid = user_sid;
     }
 
     if (build_timestamp(&timestampdir, &timestampfile) == -1) {
Index: sudo-1.8.5p2/plugins/sudoers/sudoers.c
===================================================================
--- sudo-1.8.5p2.orig/plugins/sudoers/sudoers.c	2013-02-28 22:48:59.037834126 -0500
+++ sudo-1.8.5p2/plugins/sudoers/sudoers.c	2013-02-28 22:48:59.033834126 -0500
@@ -1398,6 +1398,10 @@
 	    sudo_user.cols = atoi(*cur + sizeof("cols=") - 1);
 	    continue;
 	}
+	if (MATCHES(*cur, "sid=")) {
+	    sudo_user.sid = atoi(*cur + sizeof("sid=") - 1);
+	    continue;
+	}
     }
     if (user_cwd == NULL)
 	user_cwd = "unknown";
Index: sudo-1.8.5p2/plugins/sudoers/sudoers.h
===================================================================
--- sudo-1.8.5p2.orig/plugins/sudoers/sudoers.h	2013-02-28 22:48:59.037834126 -0500
+++ sudo-1.8.5p2/plugins/sudoers/sudoers.h	2013-02-28 22:48:59.033834126 -0500
@@ -88,6 +88,7 @@
     int   cols;
     uid_t uid;
     uid_t gid;
+    pid_t sid;
 };
 
 /*
@@ -155,8 +156,8 @@
 #define user_name		(sudo_user.name)
 #define user_uid		(sudo_user.uid)
 #define user_gid		(sudo_user.gid)
+#define user_sid		(sudo_user.sid)
 #define user_passwd		(sudo_user.pw->pw_passwd)
-#define user_uuid		(sudo_user.uuid)
 #define user_dir		(sudo_user.pw->pw_dir)
 #define user_group_list		(sudo_user.group_list)
 #define user_tty		(sudo_user.tty)
